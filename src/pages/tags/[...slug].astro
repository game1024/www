---
import HomeLayout from "@/layouts/HomeLayout.astro"
import { getCollection } from "astro:content"
import { PostCardList } from "@/components/PostCardList"

export async function getStaticPaths() {
  const allPosts = (await getCollection("posts")).filter(p => !p.data.draft);

  const tags = new Set<string>();
  for (const post of allPosts) {
    if (post.data.tags) {
      for (const tag of post.data.tags) tags.add(tag);
    }
  }

  return [...tags].map(tag => ({
    params: { slug: tag },
    props: { tag },
  }));
}

const { tag } = Astro.props;

function countWords(body: string) {
  const text = body
    .replace(/```[\s\S]*?```/g, '')
    .replace(/`[^`]+`/g, '')
    .replace(/!\[.*?\]\(.*?\)/g, '')
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
    .replace(/<[^>]+>/g, '')
    .replace(/[#*_~\-+=[\](){}]/g, '')
    .replace(/\s+/g, ' ')
    .trim();
  const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
  const englishWords = (text.match(/[a-zA-Z]+/g) || []).length;
  return chineseChars + englishWords;
}

const allPosts = await getCollection("posts");
const posts = allPosts
  .filter(p => !p.data.draft && p.data.tags?.includes(tag))
  .sort((a, b) => b.data.createdAt.getTime() - a.data.createdAt.getTime())
  .map(p => ({
    slug: p.slug,
    title: p.data.title,
    description: p.data.description,
    category: p.data.category,
    tags: p.data.tags,
    wordCount: countWords(p.body || ''),
    createdAt: p.data.createdAt.toISOString(),
  }));
---

<HomeLayout
  title={`${tag} - Game1024の博客`}
  description={`标签「${tag}」下的文章`}
  authorName="Game1024"
>
  <div class="space-y-6">
    <div class="flex items-center gap-2 text-sm text-muted-foreground">
      <a href="/tags" class="hover:text-primary transition-colors">标签</a>
      <span>/</span>
      <span class="text-foreground font-medium">{tag}</span>
      <span class="ml-1">({posts.length} 篇)</span>
    </div>

    <PostCardList client:load posts={posts} />
  </div>
</HomeLayout>
