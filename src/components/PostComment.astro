---
export interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<div class:list={["giscus-wrapper mt-8", className]}>
  <div class="giscus"></div>
</div>

<script>
  function loadGiscus() {
    const container = document.querySelector(".giscus-wrapper");
    if (!container) return;

    // 移除已有的 giscus script（支持 View Transitions）
    const existing = container.querySelector("script[src*='giscus.app']");
    if (existing) existing.remove();

    const isDark = document.documentElement.classList.contains("dark");

    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.setAttribute("data-repo", "game1024/www");
    script.setAttribute("data-repo-id", "R_kgDORM5mjQ");
    script.setAttribute("data-category", "posts");
    script.setAttribute("data-category-id", "DIC_kwDORM5mjc4C2IzG");
    script.setAttribute("data-mapping", "title");
    script.setAttribute("data-strict", "1");
    script.setAttribute("data-reactions-enabled", "1");
    script.setAttribute("data-emit-metadata", "0");
    script.setAttribute("data-input-position", "top");
    script.setAttribute("data-theme", isDark ? "dark" : "light");
    script.setAttribute("data-lang", "zh-CN");
    script.setAttribute("data-loading", "lazy");
    script.setAttribute("crossorigin", "anonymous");
    script.async = true;

    container.appendChild(script);
  }

  // 监听主题切换，同步 giscus 主题
  function syncGiscusTheme() {
    const sendThemeToGiscus = () => {
      const isDark = document.documentElement.classList.contains("dark");
      const iframe = document.querySelector<HTMLIFrameElement>("iframe.giscus-frame");
      if (iframe) {
        iframe.contentWindow?.postMessage(
          { giscus: { setConfig: { theme: isDark ? "dark" : "light" } } },
          "https://giscus.app"
        );
      }
    };

    // 监听主题变化
    const themeObserver = new MutationObserver(() => {
      sendThemeToGiscus();
      // 同时更新 script 的 data-theme，以防 iframe 尚未加载
      const script = document.querySelector("script[src*='giscus.app']");
      const isDark = document.documentElement.classList.contains("dark");
      if (script) {
        script.setAttribute("data-theme", isDark ? "dark" : "light");
      }
    });
    themeObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });

    // 监听 Giscus iframe 就绪消息，加载完成后立即同步当前主题
    window.addEventListener("message", (e) => {
      if (e.origin !== "https://giscus.app") return;
      if (typeof e.data !== "object" || !e.data.giscus) return;
      // giscus 已就绪，发送当前主题
      sendThemeToGiscus();
    });
  }

  loadGiscus();
  syncGiscusTheme();
  document.addEventListener("astro:page-load", loadGiscus);
</script>
